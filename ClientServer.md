# Предварительные сведения

В этом документе описаны основные принципы клиент-серверного взаимодействия в игре-прототипе [Two Worlds](http://twoworlds.azurewebsites.net/). Основные игровые возможности:
* Игрок управляет одним персонажем, которые может стрелять и перемещаться по игровому миру.
* Вся игра происходи в двумерной плоскости. Игрок может перемещаться лишь в двух направлениях - влево-вправо и вверх-вниз.
* Возможности персонажа (такие, как его скорость, наносимый урон и так далее) определяются в момент его выбора. Реализовано всего два вида таких персонажей. Один маленький, ездит быстро, стреляет слабо. Второй побольше, ездит медленнее и наносит больше урона. Первый стреляет снарядами, которые движутся прямолинейно и наносят урон первому попавшемуся противнику. Второй стреляет снарядами, которые наносят урон лишь в своей конечной области.
* Сервер управляет двумя видами противников. Первый (и основной вид) - это так называемые башни. Они всегда располагаются в фиксированных местах карты и атакуют игроков, если те приблизятся на определённую дистанцию. Второй вид противников - это перемещаемые пассивные сущности, которые появдяются в окрестности каждой башни. Они совершают хаотические движения. При получении урона от игрока, они начинают двигаться в его сторону и атаковать. В окретсности каждой башни может быть лишь фиксированное количество этих вторичных сущностей. При уничтожении одной, тут же появляется её замена.
* Сервер полностью авторитарный и осуществляет контроль за всеми игровыми событиями (нанесённый урон, где кто находится, области проходимости и так далее).
* Есть чат с автоматической фильтрацией ненормативной лексики. Этот чат общий без каких-либо разделений по областям, комнатам или чего-то подобного.

Сервер написан на основе [SmartFox server](https://www.smartfoxserver.com/). Сам SmartFox написан на Java и имеет клиентские библиотеки на многих языках (C#, JavaScript, Java, Objective-C, C++, ActionScript). Данное руководство имеет целью описать все необходимые сведения, достаточные для написания собственного игрового клиента (в том числе и бота). Если что-то не работает или есть вопросы - почта cgproggame@gmail.com

# Передаваемые данные от клиентов

Со стороны клиента на сервер можно передавать только три команды: две типа ExtensionRequest, одна типа PublicMessageRequest.

Первая команда типа ExtensionRequest - **RPCClientSendMovementKey.** Она вызывается в случаях, когда игрок начинает или заканчивает движение и содержит информацию как о направлении движегия, так и о направлении, куда он смотрит (эти направления не обязательно совпадают, так как игрок может ехать направо, а стрелять на лево).

Поле | Тип | Примечание
--- | --- | ---
dirIndex | Byte | Принимает значения 0, 1, ..., 8. 0 означает, что движения нет, 1 - движение вверх, 2 - движение вверх-налево, 3 - налево, 4 - налево-вниз, 5 - вниз, 6 - вниз-направо, 7 - направо, 8 - вверх-направо.
angle | Float | Угол направления в радианах, вычисляемый от положитлеьного направления оси OX против часовой стрелки

Вторая команда типа ExtensionRequest - **RPCFire.** Она вызывается в случае, если игрок нажал кнопку стрельбы и содержит информацию о локальном местоположении игрока (то есть то место, где, как думает клиент, он находится) и направлении его выстрела.

Поле | Тип | Примечание
--- | --- | ---
posX | Float | Координата по оси OX (то есть в направлении лево-право) местоположения игрока
posY | Float | Координата по оси OY (то есть направлении верх-низ) местоположения игрока
angle | Float | Угол направления в радианах, вычисляемый от положитлеьного направления оси OX против часовой стрелки

Команда типа PublicMessageRequest вызывается в случае, когда игрок посылает сообщение в чате. Эта команда является стандартной для SmartFox сервера и она содержит только строку с передваваемым текстом.


# Передаваемые данные от сервера

Со стороны сервера на клиент данные передаются с помощью команд двух типов: ExtensionRespons-ы и обновление данны MMO-сущностей. Опишем сначала формат данные ExtensionRespons-ов.

Команда **RPCTowerResurect** вызывается, когда на сервере одна из башен переходит в активный режим. Эта команда вызывается у всех клиентов, в независимости от того, где они расположены.

Поле | Тип | Примечание
--- | --- | ---
id | Int | Порядковый номер башни
life | Int | Текущее число жизней башни (совпадает с максимальным количеством)
maxLife | Int | Максимальное число жизней башни

Команда **RPCMonsterStartAtack**. Вызывется в случае, когда противник (не игрок и не башня) начал атаку. Эту команду получают только те клиенты, которые располагаются в непосредственной близости от противника.

Поле | Тип | Примечание
--- | --- | ---
monsterId | Int | Порядковый номер противника
targetType | Byte | Тип цели, которая атакуется (0 - игрок, 1 - другой такой же противник, 2 - башня)
targetId | Int | Порядковый номер цели, которая атакуется
atackTime | Float | Время атаки в секундах. Фактически это время задержки перед моментом непосредствненого нанесения урона. Если цель успеет за это время отойти на безопасное расстояние, то урон не будет нанесён.

Команда **RPCMonsterDead**. Вызывается в случае, если противник (не игрок и не башня) умирает. Команду получают только те клиенты, кто находится в непосредственной близости.

Поле | Тип | Примечание
--- | --- | ---
monsterId | Int | Порядковый номер умершего противника

Команда **RPCMonsterChangeState**. Вызывается в некоторых случаях, когда с противником что-то происходит. Используется для того, чтобы передать клиентам актуальную информацию и компенсировать какие бы то нибыло рассинхроны данных. Команду получают только те клиенты, кто находится в непосредственной близости от противника.

Поле | Тип | Примечание
--- | --- | ---
id | Int | Порядковый номер противника
life | Int | Текущее число жизней
maxLife | Int | Максимальное число жизней
state | Byte | Одно из трёх занчений: 0 - ничего не делает, 1 - движется в какую-то точку, 2 - преследует цель для атаки
speed | Float | Скорость передвижения
targetType | Byte | Одно из четырёх значений: 0 - нет цели, 1 - целью является игрок, 2 - целью является другой противник, 3 - целью является башня. Имеет смысл, если только state = 2
targetId | Int | Порядковый номер цели. Имеет смысл, если только state = 2
targetPositionX | Double | Местоположение по оси OX, в которое движется противник. Имеет смысл, если только state = 1
targetPositionY | Double |Местоположение по оси OY, в которое движется противник. Имеет смысл, если только state = 1
positionX | Double | Текущее местоположение по оси OX
positionY | Double | Текущее местоположение по оси OY

Команда **RPCClientUpdate**. Вызывается в случае, если что-то происходит с игроком. Используется для актуализации данных об игроках на клиентах. Команду получают лишь те клиенты, кто нахиотся в непосредственной близости от игрока, о котором передаются данные.

Поле | Тип | Примечание
--- | --- | ---
id | Int | Порядковый номер игрока
life | Int | Текущее число жизней игрока
maxLife | Int | Максимальное число жизней игрока
locationX | Double | Текущее местоположение игрока по оси OX
locationY | Double| Текущее местоположение игрока по оси OY
angle | Float | Угол поворота (то есть куда направлено оружие игрока). Указывается в радианах от положительного направления оси OX против часовой стрелки
isMove | Bool | true, если игрок двжиется, и false в противном случае
moveAngle | Float | Направление движение игрока. Указывается в радианах от положительного направления оси OX против часовой стрелки. Имеет смсыл только, если isMove = true
speed | Float | Скорость передвижения игрока

Команда **RPCStartBullet**. 

RPCDestoyBullet

RPCMap

RPCKillsMessage






# Подключение к серверу

В этом разделе на конкретных примерах (написанных на языке C# для Unity) опишем, как отправлять данные на сервер и как их оттуда получать.